#!/usr/bin/env node

const process = require('process');
const repl = require('repl');
require = require('esm')(module);

const { loadBasedir, buildVatController } = require('../src/index.js');

async function main() {
  let argv = process.argv.splice(2);
  let withSES = true;
  if (argv[0] === '--no-ses') {
    withSES = false;
    argv.shift();
  }
  const command = argv.shift();
  if (command !== 'run' && command !== 'shell') {
    throw new Error(`use 'vat run' or 'vat shell', not 'vat ${command}'`);
  }
  const basedir = (argv[0] === '--' || argv[0] === undefined) ? '.' : argv.shift();
  const vatArgv = argv[0] === '--' ? argv.slice(1) : argv;


  const config = await loadBasedir(basedir);
  const controller = await buildVatController(config, withSES, vatArgv);
  if (command === 'run') {
    await controller.run();
    console.log('= vat finished');
  } else if (command === 'shell') {
    const r = repl.start({ prompt: 'vat> ',
                           replMode: repl.REPL_MODE_STRICT,
                         });
    r.context.dump = () => {
      const d = controller.dump();
      console.log('Kernel Table:');
      console.log(d.kernelTable);
      console.log('Promises:');
      console.log(d.promises);
      console.log('Run Queue:');
      console.log(d.runQueue);
    };
    r.context.run = () => {console.log('run!'); controller.run();};
    r.context.step = () => {console.log('step!'); controller.step();};
  }
}

main();

