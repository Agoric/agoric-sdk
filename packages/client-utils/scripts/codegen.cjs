#!/usr/bin/env node
/* eslint-env node */
const { spawnSync } = require('node:child_process');
const path = require('node:path');
const assert = require('node:assert/strict');
const process = require('node:process');
const fsp = require('node:fs/promises');
const telescope = require('@hyperweb/telescope').default;
const rimraf = require('rimraf').rimrafSync;
const {
  getBaseTelescopeOptions,
} = require('../../cosmic-proto/tools/telescope-options.cjs');
const {
  detectGnuSed,
  fixRpcTypeImports,
  fixTypeImportForVerbatim,
} = require('../../cosmic-proto/tools/telescope-cleanup.cjs');

const protoDirs = [path.join(__dirname, '/../../cosmic-proto/proto')];
const outPath = path.join(__dirname, '../src/codegen');
rimraf(outPath);

const isRpcFile = fileName =>
  fileName.includes('.rpc.') || /^(rpc\.query|rpc\.tx)\.ts$/.test(fileName);

/**
 * Rewrite non-RPC relative imports in generated RPC modules to cosmic-proto.
 *
 * @param {string} directory
 * @returns {Promise<string[]>}
 */
const rewriteRpcImportsToCosmicProto = async directory => {
  /** @type {string[]} */
  const changed = [];

  /**
   * @param {string} dirPath
   */
  const walk = async dirPath => {
    const entries = await fsp.readdir(dirPath, { withFileTypes: true });
    for (const entry of entries) {
      const fullPath = path.join(dirPath, entry.name);
      if (entry.isDirectory()) {
        // eslint-disable-next-line no-await-in-loop
        await walk(fullPath);
        continue;
      }
      if (!entry.isFile() || !isRpcFile(entry.name)) {
        continue;
      }

      // eslint-disable-next-line no-await-in-loop
      const source = await fsp.readFile(fullPath, 'utf8');
      const next = source.replaceAll(
        /((?:from\s+['"]|import\(\s*['"]))(\.{1,2}\/[^'"]+)(['"]\s*\)?)/g,
        (match, start, specifier, end) => {
          if (
            specifier.includes('.rpc.') ||
            /^\.\/rpc\.(query|tx)\.js$/.test(specifier)
          ) {
            return match;
          }
          const resolved = path.resolve(path.dirname(fullPath), specifier);
          const modulePath = path
            .relative(directory, resolved)
            .replaceAll('\\', '/');
          return `${start}@agoric/cosmic-proto/codegen/${modulePath}${end}`;
        },
      );
      if (next !== source) {
        // eslint-disable-next-line no-await-in-loop
        await fsp.writeFile(fullPath, next);
        changed.push(fullPath);
      }
    }
  };

  await walk(directory);
  return changed;
};

/**
 * Remove all generated non-RPC modules from client-utils.
 *
 * @param {string} directory
 * @returns {Promise<string[]>}
 */
const pruneNonRpcGeneratedModules = async directory => {
  /** @type {string[]} */
  const removed = [];

  /**
   * @param {string} dirPath
   */
  const walk = async dirPath => {
    const entries = await fsp.readdir(dirPath, { withFileTypes: true });
    for (const entry of entries) {
      const fullPath = path.join(dirPath, entry.name);
      if (entry.isDirectory()) {
        // eslint-disable-next-line no-await-in-loop
        await walk(fullPath);
        continue;
      }
      if (
        !entry.isFile() ||
        !entry.name.endsWith('.ts') ||
        isRpcFile(entry.name)
      ) {
        continue;
      }
      // eslint-disable-next-line no-await-in-loop
      await fsp.unlink(fullPath);
      removed.push(fullPath);
    }
  };

  await walk(directory);
  return removed;
};

const options = getBaseTelescopeOptions();
options.rpcClients = { ...options.rpcClients, enabled: true };
options.stargateClients = { enabled: true };

// XXX copied from cosmic-proto's codegen
telescope({
  protoDirs,
  outPath,
  options,
})
  .then(async () => {
    console.log('ðŸ”¨ code generated by Telescope');

    // for all files under codegen/ replace "import { JsonSafe" with "import type { JsonSafe"
    const gnuSed = detectGnuSed();
    fixTypeImportForVerbatim('./src/codegen', gnuSed);
    console.log('ðŸ”§ type keyword added');

    const prettierResult = spawnSync(
      'yarn',
      ['run', '--top-level', 'prettier', '--write', 'src/codegen'],
      {
        cwd: path.join(__dirname, '..'),
        stdio: 'inherit',
      },
    );
    assert.equal(prettierResult.status, 0);
    console.log('ðŸ’… code formatted by Prettier');

    const cleanedFiles = await fixRpcTypeImports(outPath);
    const rewrittenFiles = await rewriteRpcImportsToCosmicProto(outPath);
    const removedFiles = await pruneNonRpcGeneratedModules(outPath);
    const postProcessFiles = [...new Set([...cleanedFiles, ...rewrittenFiles])];
    if (postProcessFiles.length > 0) {
      const prettierHelpersResult = spawnSync(
        'yarn',
        [
          'run',
          '--top-level',
          'prettier',
          '--write',
          ...postProcessFiles.map(file =>
            path.relative(path.join(__dirname, '..'), file),
          ),
        ],
        {
          cwd: path.join(__dirname, '..'),
          stdio: 'inherit',
        },
      );
      assert.equal(prettierHelpersResult.status, 0);
    }
    console.log(
      `ðŸ§¹ rewrote RPC imports and pruned ${removedFiles.length} generated support modules`,
    );

    console.log('â„¹ï¸ `yarn build && yarn test` to test it.');
  })
  .catch(e => {
    console.error(e);
    process.exit(1);
  });
