# Run after merge to trunk
# Note that this relies on branch protection having:
#  Require branches to be up to date before merging
on:
  push:
    branches:
      - 'usman/fix-after-merge'
  workflow_dispatch:

jobs:
  build:
    if: ${{ github.repository_owner == 'agoric' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: ['node-new', 'node-old']
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'true'
      - uses: ./.github/actions/restore-node
        with:
          node-version: ${{ matrix.node-version}}
      - name: notify on failure
        if: failure()
        uses: ./.github/actions/notify-status
        with:
          from: ${{ secrets.NOTIFY_EMAIL_FROM }}
          to: ${{ secrets.NOTIFY_EMAIL_TO }}
          password: ${{ secrets.NOTIFY_EMAIL_PASSWORD }}
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}

  coverage:
    needs: build
    runs-on: ubuntu-latest
    if: ${{github.event_name == 'push' }}
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/restore-node
        with:
          node-version: 'node-new'

      - env:
          NODE_MEMORY_SIZE: "4096"
        name: generate test coverage report
        run: ./scripts/ci/generate-test-coverage-report.sh
      - uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage
