name: Swing-Store Diagnostics

on:
  pull_request:
    paths:
      - 'packages/swing-store/**'
      - '.github/workflows/swing-store-diagnostics.yml'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

jobs:
  diagnostics:
    name: swing-store (node-${{ matrix.node-version }})
    runs-on: ubuntu-latest-16core
    strategy:
      fail-fast: false
      matrix:
        node-version: ['20', '22', '24']
    env:
      AGORIC_AVA_USE_TAP: true
      NODE_V8_COVERAGE: coverage
      TEST_COLLECT: 'tee -a _testoutput.txt'
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: 'true'

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Enable corepack
        run: corepack enable

      - name: Install dependencies
        run: yarn install

      - name: Build workspace
        run: yarn build

      - name: Run swing-store diagnostics
        run: |
          set +e
          trap 'echo "swing-store diag shell received SIGHUP"' HUP
          diag_module="$PWD/packages/swing-store/test/ava-process-diagnostics.js"
          export NODE_OPTIONS="--require=$diag_module ${NODE_OPTIONS:-}"

          cd packages/swing-store || exit $?
          node ../../node_modules/ava/entrypoints/cli.mjs > >(tee -a _testoutput.txt) 2>&1
          rc=$?

          if [ "$rc" -ne 0 ]; then
            echo "::group::swing-store failure diagnostics"
            echo "test command exit code: $rc"
            if [ "$rc" -eq 129 ]; then
              echo "exit 129 indicates SIGHUP"
            fi
            echo "NODE_OPTIONS: ${NODE_OPTIONS}"
            echo "node: $(node -v)"
            echo "yarn: $(yarn -v)"
            echo "pwd: $(pwd)"
            echo "--- ulimit -a ---"
            ulimit -a || true
            echo "--- process tree (pstree) ---"
            pstree -pal "$$" || true
            echo "--- process list (filtered for test processes) ---"
            ps -eo pid,ppid,pgid,sid,stat,etime,pcpu,pmem,comm,args | grep -E '(PID|ava|node|yarn|tee)' || true
            echo "--- last 200 lines of _testoutput.txt ---"
            tail -n 200 _testoutput.txt || true
            echo "::endgroup::"
          fi

          exit "$rc"

      - name: Upload swing-store diagnostics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: swing-store-diag-node${{ matrix.node-version }}
          path: |
            packages/swing-store/_testoutput.txt
            packages/swing-store/coverage
          if-no-files-found: ignore
