# Snapshot report for `test/deposit-tools.test.ts`

The actual snapshot is saved in `deposit-tools.test.ts.snap`.

Generated by [AVA](https://avajs.dev).

## handleDeposit works with mocked dependencies

> Snapshot 1

    {
      policyVersion: 4,
      rebalanceCount: 2,
      steps: [
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1000n,
          },
          dest: '@agoric',
          src: '<Deposit>',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1000n,
          },
          dest: '@noble',
          src: '@agoric',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 475n,
          },
          dest: 'USDN',
          detail: {
            usdnOut: 473n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 525n,
          },
          dest: '@Arbitrum',
          detail: {
            evmGas: 1n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 1330378n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 305n,
          },
          dest: 'Aave_Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 307420n,
          },
          src: '@Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 220n,
          },
          dest: 'Compound_Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 166861n,
          },
          src: '@Arbitrum',
        },
      ],
    }

## handleDeposit handles different position types correctly

> Snapshot 1

    [
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 1000n,
        },
        dest: '@agoric',
        src: '<Deposit>',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 1000n,
        },
        dest: '@noble',
        src: '@agoric',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 431n,
        },
        dest: 'USDN',
        detail: {
          usdnOut: 429n,
        },
        src: '@noble',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 65n,
        },
        dest: 'USDNVault',
        detail: {
          usdnOut: 63n,
        },
        src: '@noble',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 306n,
        },
        dest: '@Avalanche',
        detail: {
          evmGas: 1n,
        },
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 1330378n,
        },
        src: '@noble',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 198n,
        },
        dest: '@Ethereum',
        detail: {
          evmGas: 1n,
        },
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 1330378n,
        },
        src: '@noble',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 198n,
        },
        dest: 'Compound_Ethereum',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 166861n,
        },
        src: '@Ethereum',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 306n,
        },
        dest: 'Aave_Avalanche',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 307420n,
        },
        src: '@Avalanche',
      },
    ]

## planRebalanceToAllocations moves funds when needed

> Snapshot 1

    [
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 600n,
        },
        dest: '@noble',
        src: 'USDN',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 600n,
        },
        dest: '@Arbitrum',
        detail: {
          evmGas: 1n,
        },
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 1330378n,
        },
        src: '@noble',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 400n,
        },
        dest: 'Aave_Arbitrum',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 307420n,
        },
        src: '@Arbitrum',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 200n,
        },
        dest: 'Compound_Arbitrum',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 166861n,
        },
        src: '@Arbitrum',
      },
    ]

## planWithdrawFromAllocations withdraws and rebalances

> Snapshot 1

    [
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 1600n,
        },
        dest: '@noble',
        src: 'USDN',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 600n,
        },
        dest: '@Arbitrum',
        detail: {
          evmGas: 1n,
        },
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 1330378n,
        },
        src: '@noble',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 1000n,
        },
        dest: '@agoric',
        src: '@noble',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 400n,
        },
        dest: 'Aave_Arbitrum',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 307420n,
        },
        src: '@Arbitrum',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 200n,
        },
        dest: 'Compound_Arbitrum',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 166861n,
        },
        src: '@Arbitrum',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 1000n,
        },
        dest: '<Cash>',
        src: '@agoric',
      },
    ]

## planWithdrawFromAllocations with no target preserves relative amounts

> Snapshot 1

    [
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 400n,
        },
        dest: '@Arbitrum',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 257759n,
        },
        src: 'Aave_Arbitrum',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 200n,
        },
        dest: '@Arbitrum',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 135389n,
        },
        src: 'Compound_Arbitrum',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 600n,
        },
        dest: '@agoric',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 166452n,
        },
        src: '@Arbitrum',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 400n,
        },
        dest: '@noble',
        src: 'USDN',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 400n,
        },
        dest: '@agoric',
        src: '@noble',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 1000n,
        },
        dest: '<Cash>',
        src: '@agoric',
      },
    ]

## ordering of steps should be correct

> Snapshot 1

    [
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 29567786n,
        },
        dest: '@Avalanche',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 257759n,
        },
        src: 'Aave_Avalanche',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 29567786n,
        },
        dest: '@agoric',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 166452n,
        },
        src: '@Avalanche',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 29567786n,
        },
        dest: '@noble',
        src: '@agoric',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 7211655n,
        },
        dest: '@Arbitrum',
        detail: {
          evmGas: 1n,
        },
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 1330378n,
        },
        src: '@noble',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 7211655n,
        },
        dest: '@Ethereum',
        detail: {
          evmGas: 1n,
        },
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 1330378n,
        },
        src: '@noble',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 7211655n,
        },
        dest: '@Optimism',
        detail: {
          evmGas: 1n,
        },
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 1330378n,
        },
        src: '@noble',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 7932821n,
        },
        dest: '@Base',
        detail: {
          evmGas: 1n,
        },
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 1330378n,
        },
        src: '@noble',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 7211655n,
        },
        dest: 'Aave_Arbitrum',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 307420n,
        },
        src: '@Arbitrum',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 7932821n,
        },
        dest: 'Aave_Base',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 307420n,
        },
        src: '@Base',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 7211655n,
        },
        dest: 'Aave_Ethereum',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 307420n,
        },
        src: '@Ethereum',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 7211655n,
        },
        dest: 'Aave_Optimism',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 307420n,
        },
        src: '@Optimism',
      },
    ]

## Full ordering of steps should be correct

> Snapshot 1

    [
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 2100054n,
        },
        dest: '@Avalanche',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 257759n,
        },
        src: 'Aave_Avalanche',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 2100054n,
        },
        dest: '@agoric',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 166452n,
        },
        src: '@Avalanche',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 3150000n,
        },
        dest: '@Base',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 257759n,
        },
        src: 'Aave_Base',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 1500006n,
        },
        dest: 'Compound_Base',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 166861n,
        },
        src: '@Base',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 1649994n,
        },
        dest: '@agoric',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 166452n,
        },
        src: '@Base',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 2099996n,
        },
        dest: '@Optimism',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 257759n,
        },
        src: 'Aave_Optimism',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 2099996n,
        },
        dest: '@Arbitrum',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 135389n,
        },
        src: 'Compound_Arbitrum',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 1500006n,
        },
        dest: 'Aave_Arbitrum',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 307420n,
        },
        src: '@Arbitrum',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 599990n,
        },
        dest: '@agoric',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 166452n,
        },
        src: '@Arbitrum',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 4350038n,
        },
        dest: '@noble',
        src: '@agoric',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 3000012n,
        },
        dest: '@Ethereum',
        detail: {
          evmGas: 1n,
        },
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 1330378n,
        },
        src: '@noble',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 1350026n,
        },
        dest: '@Optimism',
        detail: {
          evmGas: 1n,
        },
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 1330378n,
        },
        src: '@noble',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 1500006n,
        },
        dest: 'Aave_Ethereum',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 307420n,
        },
        src: '@Ethereum',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 1500006n,
        },
        dest: 'Compound_Ethereum',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 166861n,
        },
        src: '@Ethereum',
      },
      {
        amount: {
          brand: Object @Alleged: mock brand {},
          value: 3450022n,
        },
        dest: 'Compound_Optimism',
        fee: {
          brand: Object @Alleged: fee brand (BLD) {},
          value: 166861n,
        },
        src: '@Optimism',
      },
    ]
