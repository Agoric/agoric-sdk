# Snapshot report for `test/deposit-tools.test.ts`

The actual snapshot is saved in `deposit-tools.test.ts.snap`.

Generated by [AVA](https://avajs.dev).

## handleDeposit works with mocked dependencies

> Snapshot 1

    {
      plan: {
        flow: [
          {
            amount: {
              brand: Object @Alleged: mock brand {},
              value: 9650000n,
            },
            dest: '@agoric',
            src: '<Deposit>',
          },
          {
            amount: {
              brand: Object @Alleged: mock brand {},
              value: 9650000n,
            },
            dest: '@noble',
            src: '@agoric',
          },
          {
            amount: {
              brand: Object @Alleged: mock brand {},
              value: 4800000n,
            },
            dest: 'USDN',
            detail: {
              usdnOut: 4797599n,
            },
            src: '@noble',
          },
          {
            amount: {
              brand: Object @Alleged: mock brand {},
              value: 4850000n,
            },
            dest: '@Arbitrum',
            detail: {
              evmGas: 12n,
            },
            fee: {
              brand: Object @Alleged: fee brand (BLD) {},
              value: 14513220n,
            },
            src: '@noble',
          },
          {
            amount: {
              brand: Object @Alleged: mock brand {},
              value: 2900000n,
            },
            dest: 'Aave_Arbitrum',
            fee: {
              brand: Object @Alleged: fee brand (BLD) {},
              value: 5000000n,
            },
            src: '@Arbitrum',
          },
          {
            amount: {
              brand: Object @Alleged: mock brand {},
              value: 1950000n,
            },
            dest: 'Compound_Arbitrum',
            fee: {
              brand: Object @Alleged: fee brand (BLD) {},
              value: 5000000n,
            },
            src: '@Arbitrum',
          },
        ],
        order: [
          [
            1,
            [
              0,
            ],
          ],
          [
            2,
            [
              1,
            ],
          ],
          [
            3,
            [
              1,
            ],
          ],
          [
            4,
            [
              3,
            ],
          ],
          [
            5,
            [
              3,
            ],
          ],
        ],
      },
      policyVersion: 4,
      rebalanceCount: 2,
    }

## handleDeposit handles different position types correctly

> steps

    [
      '<Deposit> -> @agoric $1',
      '@agoric -> @noble $1',
      '@noble -> USDN $0.43',
      '@noble -> USDNVault $0.065',
      '@noble -> @Avalanche $0.30625 [fee 14.51322 fee brand (BLD)]',
      '@noble -> @Ethereum $0.19875 [fee 14.51322 fee brand (BLD)]',
      '@Avalanche -> Aave_Avalanche $0.30625 [fee 5 fee brand (BLD)]',
      '@Ethereum -> Compound_Ethereum $0.19875 [fee 5 fee brand (BLD)]',
    ]

> step dependencies

    [
      'step 1 depends upon step(s) 0',
      'step 2 depends upon step(s) 1',
      'step 3 depends upon step(s) 1',
      'step 4 depends upon step(s) 1',
      'step 5 depends upon step(s) 1',
      'step 6 depends upon step(s) 4',
      'step 7 depends upon step(s) 5',
    ]

> raw plan

    {
      flow: [
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1000000n,
          },
          dest: '@agoric',
          src: '<Deposit>',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1000000n,
          },
          dest: '@noble',
          src: '@agoric',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 430000n,
          },
          dest: 'USDN',
          detail: {
            usdnOut: 429784n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 65000n,
          },
          dest: 'USDNVault',
          detail: {
            usdnOut: 64966n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 306250n,
          },
          dest: '@Avalanche',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 198750n,
          },
          dest: '@Ethereum',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 306250n,
          },
          dest: 'Aave_Avalanche',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Avalanche',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 198750n,
          },
          dest: 'Compound_Ethereum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Ethereum',
        },
      ],
      order: [
        [
          1,
          [
            0,
          ],
        ],
        [
          2,
          [
            1,
          ],
        ],
        [
          3,
          [
            1,
          ],
        ],
        [
          4,
          [
            1,
          ],
        ],
        [
          5,
          [
            1,
          ],
        ],
        [
          6,
          [
            4,
          ],
        ],
        [
          7,
          [
            5,
          ],
        ],
      ],
    }

## planRebalanceToAllocations moves funds when needed

> steps

    [
      'USDN -> @noble $0.0006',
      '@noble -> @Arbitrum $0.0006 [fee 14.51322 fee brand (BLD)]',
      '@Arbitrum -> Aave_Arbitrum $0.0004 [fee 5 fee brand (BLD)]',
      '@Arbitrum -> Compound_Arbitrum $0.0002 [fee 5 fee brand (BLD)]',
    ]

> step dependencies

    [
      'step 1 depends upon step(s) 0',
      'step 2 depends upon step(s) 1',
      'step 3 depends upon step(s) 1',
    ]

> raw plan

    {
      flow: [
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 600n,
          },
          dest: '@noble',
          src: 'USDN',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 600n,
          },
          dest: '@Arbitrum',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 400n,
          },
          dest: 'Aave_Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 200n,
          },
          dest: 'Compound_Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Arbitrum',
        },
      ],
      order: [
        [
          1,
          [
            0,
          ],
        ],
        [
          2,
          [
            1,
          ],
        ],
        [
          3,
          [
            1,
          ],
        ],
      ],
    }

## planWithdrawFromAllocations withdraws and rebalances

> steps

    [
      'USDN -> @noble $0.0016',
      '@noble -> @Arbitrum $0.0006 [fee 14.51322 fee brand (BLD)]',
      '@noble -> @agoric $0.001',
      '@Arbitrum -> Aave_Arbitrum $0.0004 [fee 5 fee brand (BLD)]',
      '@Arbitrum -> Compound_Arbitrum $0.0002 [fee 5 fee brand (BLD)]',
      '@agoric -> <Cash> $0.001',
    ]

> step dependencies

    [
      'step 1 depends upon step(s) 0',
      'step 2 depends upon step(s) 0',
      'step 3 depends upon step(s) 1',
      'step 4 depends upon step(s) 1',
      'step 5 depends upon step(s) 2',
    ]

> raw plan

    {
      flow: [
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1600n,
          },
          dest: '@noble',
          src: 'USDN',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 600n,
          },
          dest: '@Arbitrum',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1000n,
          },
          dest: '@agoric',
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 400n,
          },
          dest: 'Aave_Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 200n,
          },
          dest: 'Compound_Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1000n,
          },
          dest: '<Cash>',
          src: '@agoric',
        },
      ],
      order: [
        [
          1,
          [
            0,
          ],
        ],
        [
          2,
          [
            0,
          ],
        ],
        [
          3,
          [
            1,
          ],
        ],
        [
          4,
          [
            1,
          ],
        ],
        [
          5,
          [
            2,
          ],
        ],
      ],
    }

## planWithdrawFromAllocations can withdraw to an EVM account

> steps

    [
      'USDN -> @noble $0.0016',
      '@noble -> @Arbitrum $0.0006 [fee 14.51322 fee brand (BLD)]',
      '@noble -> @Ethereum $0.001 [fee 14.51322 fee brand (BLD)]',
      '@Arbitrum -> Aave_Arbitrum $0.0004 [fee 5 fee brand (BLD)]',
      '@Arbitrum -> Compound_Arbitrum $0.0002 [fee 5 fee brand (BLD)]',
      '@Ethereum -> -Ethereum $0.001 [fee 5 fee brand (BLD)]',
    ]

> step dependencies

    [
      'step 1 depends upon step(s) 0',
      'step 2 depends upon step(s) 0',
      'step 3 depends upon step(s) 1',
      'step 4 depends upon step(s) 1',
      'step 5 depends upon step(s) 2',
    ]

> raw plan

    {
      flow: [
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1600n,
          },
          dest: '@noble',
          src: 'USDN',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 600n,
          },
          dest: '@Arbitrum',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1000n,
          },
          dest: '@Ethereum',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 400n,
          },
          dest: 'Aave_Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 200n,
          },
          dest: 'Compound_Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1000n,
          },
          dest: '-Ethereum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Ethereum',
        },
      ],
      order: [
        [
          1,
          [
            0,
          ],
        ],
        [
          2,
          [
            0,
          ],
        ],
        [
          3,
          [
            1,
          ],
        ],
        [
          4,
          [
            1,
          ],
        ],
        [
          5,
          [
            2,
          ],
        ],
      ],
    }

## planWithdrawFromAllocations considers former allocation targets

> steps

    [
      'Aave_Avalanche -> @Avalanche $0.001 [fee 5 fee brand (BLD)]',
      '@Avalanche -> @agoric $0.001 [fee 5 fee brand (BLD)]',
      'Compound_Arbitrum -> @Arbitrum $0.0002 [fee 5 fee brand (BLD)]',
      '@Arbitrum -> @agoric $0.0002 [fee 5 fee brand (BLD)]',
      '@agoric -> <Cash> $0.0012',
    ]

> step dependencies

    [
      'step 1 depends upon step(s) 0',
      'step 3 depends upon step(s) 2',
      'step 4 depends upon step(s) 1 and 3',
    ]

> raw plan

    {
      flow: [
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1000n,
          },
          dest: '@Avalanche',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: 'Aave_Avalanche',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1000n,
          },
          dest: '@agoric',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Avalanche',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 200n,
          },
          dest: '@Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: 'Compound_Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 200n,
          },
          dest: '@agoric',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1200n,
          },
          dest: '<Cash>',
          src: '@agoric',
        },
      ],
      order: [
        [
          1,
          [
            0,
          ],
        ],
        [
          3,
          [
            2,
          ],
        ],
        [
          4,
          [
            1,
            3,
          ],
        ],
      ],
    }

## planWithdrawFromAllocations with no target preserves relative positions

> steps

    [
      'Aave_Arbitrum -> @Arbitrum $0.0004 [fee 5 fee brand (BLD)]',
      'Compound_Arbitrum -> @Arbitrum $0.0002 [fee 5 fee brand (BLD)]',
      '@Arbitrum -> @agoric $0.0008 [fee 5 fee brand (BLD)]',
      'USDN -> @noble $0.0004',
      '@noble -> @agoric $0.0004',
      '@agoric -> <Cash> $0.0012',
    ]

> step dependencies

    [
      'step 2 depends upon step(s) 0 and 1',
      'step 4 depends upon step(s) 3',
      'step 5 depends upon step(s) 2 and 4',
    ]

> raw plan

    {
      flow: [
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 400n,
          },
          dest: '@Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: 'Aave_Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 200n,
          },
          dest: '@Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: 'Compound_Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 800n,
          },
          dest: '@agoric',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 400n,
          },
          dest: '@noble',
          src: 'USDN',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 400n,
          },
          dest: '@agoric',
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1200n,
          },
          dest: '<Cash>',
          src: '@agoric',
        },
      ],
      order: [
        [
          2,
          [
            0,
            1,
          ],
        ],
        [
          4,
          [
            3,
          ],
        ],
        [
          5,
          [
            2,
            4,
          ],
        ],
      ],
    }

## planWithdrawFromAllocations with no target and no positions preserves relative amounts

> steps

    [
      '@Arbitrum -> @agoric $0.0005 [fee 5 fee brand (BLD)]',
      '@noble -> @agoric $0.0005',
      '@agoric -> <Cash> $0.001',
    ]

> step dependencies

    [
      'step 2 depends upon step(s) 0 and 1',
    ]

> raw plan

    {
      flow: [
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 500n,
          },
          dest: '@agoric',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 500n,
          },
          dest: '@agoric',
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1000n,
          },
          dest: '<Cash>',
          src: '@agoric',
        },
      ],
      order: [
        [
          2,
          [
            0,
            1,
          ],
        ],
      ],
    }

## planRebalanceToAllocations regression - single source, 2x

> steps

    [
      'Aave_Avalanche -> @Avalanche $5.913557 [fee 5 fee brand (BLD)]',
      '@Avalanche -> @agoric $5.913557 [fee 5 fee brand (BLD)]',
      '@agoric -> @noble $5.913557',
      '@noble -> @Arbitrum $1.442331 [fee 14.51322 fee brand (BLD)]',
      '@noble -> @Base $1.586564 [fee 14.51322 fee brand (BLD)]',
      '@noble -> @Ethereum $1.442331 [fee 14.51322 fee brand (BLD)]',
      '@noble -> @Optimism $1.442331 [fee 14.51322 fee brand (BLD)]',
      '@Arbitrum -> Aave_Arbitrum $1.442331 [fee 5 fee brand (BLD)]',
      '@Base -> Aave_Base $1.586564 [fee 5 fee brand (BLD)]',
      '@Ethereum -> Aave_Ethereum $1.442331 [fee 5 fee brand (BLD)]',
      '@Optimism -> Aave_Optimism $1.442331 [fee 5 fee brand (BLD)]',
    ]

> step dependencies

    [
      'step 1 depends upon step(s) 0',
      'step 2 depends upon step(s) 1',
      'step 3 depends upon step(s) 2',
      'step 4 depends upon step(s) 2',
      'step 5 depends upon step(s) 2',
      'step 6 depends upon step(s) 2',
      'step 7 depends upon step(s) 3',
      'step 8 depends upon step(s) 4',
      'step 9 depends upon step(s) 5',
      'step 10 depends upon step(s) 6',
    ]

> raw plan

    {
      flow: [
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 5913557n,
          },
          dest: '@Avalanche',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: 'Aave_Avalanche',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 5913557n,
          },
          dest: '@agoric',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Avalanche',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 5913557n,
          },
          dest: '@noble',
          src: '@agoric',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1442331n,
          },
          dest: '@Arbitrum',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1586564n,
          },
          dest: '@Base',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1442331n,
          },
          dest: '@Ethereum',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1442331n,
          },
          dest: '@Optimism',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1442331n,
          },
          dest: 'Aave_Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1586564n,
          },
          dest: 'Aave_Base',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Base',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1442331n,
          },
          dest: 'Aave_Ethereum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Ethereum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1442331n,
          },
          dest: 'Aave_Optimism',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Optimism',
        },
      ],
      order: [
        [
          1,
          [
            0,
          ],
        ],
        [
          2,
          [
            1,
          ],
        ],
        [
          3,
          [
            2,
          ],
        ],
        [
          4,
          [
            2,
          ],
        ],
        [
          5,
          [
            2,
          ],
        ],
        [
          6,
          [
            2,
          ],
        ],
        [
          7,
          [
            3,
          ],
        ],
        [
          8,
          [
            4,
          ],
        ],
        [
          9,
          [
            5,
          ],
        ],
        [
          10,
          [
            6,
          ],
        ],
      ],
    }

## planRebalanceToAllocations regression - single source, 10x

> steps

    [
      'Aave_Avalanche -> @Avalanche $29.567786 [fee 5 fee brand (BLD)]',
      '@Avalanche -> @agoric $29.567786 [fee 5 fee brand (BLD)]',
      '@agoric -> @noble $29.567786',
      '@noble -> @Arbitrum $7.211655 [fee 14.51322 fee brand (BLD)]',
      '@noble -> @Base $7.932821 [fee 14.51322 fee brand (BLD)]',
      '@noble -> @Ethereum $7.211655 [fee 14.51322 fee brand (BLD)]',
      '@noble -> @Optimism $7.211655 [fee 14.51322 fee brand (BLD)]',
      '@Arbitrum -> Aave_Arbitrum $7.211655 [fee 5 fee brand (BLD)]',
      '@Base -> Aave_Base $7.932821 [fee 5 fee brand (BLD)]',
      '@Ethereum -> Aave_Ethereum $7.211655 [fee 5 fee brand (BLD)]',
      '@Optimism -> Aave_Optimism $7.211655 [fee 5 fee brand (BLD)]',
    ]

> step dependencies

    [
      'step 1 depends upon step(s) 0',
      'step 2 depends upon step(s) 1',
      'step 3 depends upon step(s) 2',
      'step 4 depends upon step(s) 2',
      'step 5 depends upon step(s) 2',
      'step 6 depends upon step(s) 2',
      'step 7 depends upon step(s) 3',
      'step 8 depends upon step(s) 4',
      'step 9 depends upon step(s) 5',
      'step 10 depends upon step(s) 6',
    ]

> raw plan

    {
      flow: [
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 29567786n,
          },
          dest: '@Avalanche',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: 'Aave_Avalanche',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 29567786n,
          },
          dest: '@agoric',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Avalanche',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 29567786n,
          },
          dest: '@noble',
          src: '@agoric',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 7211655n,
          },
          dest: '@Arbitrum',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 7932821n,
          },
          dest: '@Base',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 7211655n,
          },
          dest: '@Ethereum',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 7211655n,
          },
          dest: '@Optimism',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 7211655n,
          },
          dest: 'Aave_Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 7932821n,
          },
          dest: 'Aave_Base',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Base',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 7211655n,
          },
          dest: 'Aave_Ethereum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Ethereum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 7211655n,
          },
          dest: 'Aave_Optimism',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Optimism',
        },
      ],
      order: [
        [
          1,
          [
            0,
          ],
        ],
        [
          2,
          [
            1,
          ],
        ],
        [
          3,
          [
            2,
          ],
        ],
        [
          4,
          [
            2,
          ],
        ],
        [
          5,
          [
            2,
          ],
        ],
        [
          6,
          [
            2,
          ],
        ],
        [
          7,
          [
            3,
          ],
        ],
        [
          8,
          [
            4,
          ],
        ],
        [
          9,
          [
            5,
          ],
        ],
        [
          10,
          [
            6,
          ],
        ],
      ],
    }

## planRebalanceToAllocations regression - multiple sources

> steps

    [
      'Aave_Avalanche -> @Avalanche $2.100054 [fee 5 fee brand (BLD)]',
      'Aave_Base -> @Base $3.15 [fee 5 fee brand (BLD)]',
      '@Base -> Compound_Base $1.500006 [fee 5 fee brand (BLD)]',
      '@Base -> @Avalanche $1.649994 [fee 5 fee brand (BLD)]',
      'Aave_Optimism -> @Optimism $2.099996 [fee 5 fee brand (BLD)]',
      'Compound_Arbitrum -> @Arbitrum $2.099996 [fee 5 fee brand (BLD)]',
      '@Arbitrum -> Aave_Arbitrum $1.500006 [fee 5 fee brand (BLD)]',
      '@Arbitrum -> @agoric $0.59999 [fee 5 fee brand (BLD)]',
      '@Avalanche -> @agoric $3.750048 [fee 5 fee brand (BLD)]',
      '@agoric -> @noble $4.350038',
      '@noble -> @Ethereum $3.000012 [fee 14.51322 fee brand (BLD)]',
      '@noble -> @Optimism $1.350026 [fee 14.51322 fee brand (BLD)]',
      '@Ethereum -> Aave_Ethereum $1.500006 [fee 5 fee brand (BLD)]',
      '@Ethereum -> Compound_Ethereum $1.500006 [fee 5 fee brand (BLD)]',
      '@Optimism -> Compound_Optimism $3.450022 [fee 5 fee brand (BLD)]',
    ]

> step dependencies

    [
      'step 2 depends upon step(s) 1',
      'step 3 depends upon step(s) 1',
      'step 6 depends upon step(s) 5',
      'step 7 depends upon step(s) 5',
      'step 8 depends upon step(s) 0 and 3',
      'step 9 depends upon step(s) 7 and 8',
      'step 10 depends upon step(s) 9',
      'step 11 depends upon step(s) 9',
      'step 12 depends upon step(s) 10',
      'step 13 depends upon step(s) 10',
      'step 14 depends upon step(s) 4 and 11',
    ]

> raw plan

    {
      flow: [
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 2100054n,
          },
          dest: '@Avalanche',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: 'Aave_Avalanche',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 3150000n,
          },
          dest: '@Base',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: 'Aave_Base',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1500006n,
          },
          dest: 'Compound_Base',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Base',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1649994n,
          },
          dest: '@Avalanche',
          detail: {
            cctpVersion: 2n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Base',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 2099996n,
          },
          dest: '@Optimism',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: 'Aave_Optimism',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 2099996n,
          },
          dest: '@Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: 'Compound_Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1500006n,
          },
          dest: 'Aave_Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 599990n,
          },
          dest: '@agoric',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 3750048n,
          },
          dest: '@agoric',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Avalanche',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 4350038n,
          },
          dest: '@noble',
          src: '@agoric',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 3000012n,
          },
          dest: '@Ethereum',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1350026n,
          },
          dest: '@Optimism',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1500006n,
          },
          dest: 'Aave_Ethereum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Ethereum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 1500006n,
          },
          dest: 'Compound_Ethereum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Ethereum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 3450022n,
          },
          dest: 'Compound_Optimism',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Optimism',
        },
      ],
      order: [
        [
          2,
          [
            1,
          ],
        ],
        [
          3,
          [
            1,
          ],
        ],
        [
          6,
          [
            5,
          ],
        ],
        [
          7,
          [
            5,
          ],
        ],
        [
          8,
          [
            0,
            3,
          ],
        ],
        [
          9,
          [
            7,
            8,
          ],
        ],
        [
          10,
          [
            9,
          ],
        ],
        [
          11,
          [
            9,
          ],
        ],
        [
          12,
          [
            10,
          ],
        ],
        [
          13,
          [
            10,
          ],
        ],
        [
          14,
          [
            4,
            11,
          ],
        ],
      ],
    }

## planRebalanceToAllocations selects correct routes for Base â†’ Avalanche + Noble split

> Base to Avalanche + Noble split routing

    {
      flow: [
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 20000000n,
          },
          dest: '@Base',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: 'Aave_Base',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 20000000n,
          },
          dest: '@Avalanche',
          detail: {
            cctpVersion: 2n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Base',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 10000000n,
          },
          dest: 'Aave_Avalanche',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Avalanche',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 10000000n,
          },
          dest: '@agoric',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Avalanche',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 10000000n,
          },
          dest: '@noble',
          src: '@agoric',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 10000000n,
          },
          dest: 'USDN',
          detail: {
            usdnOut: 9989999n,
          },
          src: '@noble',
        },
      ],
      order: [
        [
          1,
          [
            0,
          ],
        ],
        [
          2,
          [
            1,
          ],
        ],
        [
          3,
          [
            1,
          ],
        ],
        [
          4,
          [
            3,
          ],
        ],
        [
          5,
          [
            4,
          ],
        ],
      ],
    }

## planRebalanceToAllocations regression - CCTPv2 multi-source rebalance

> CCTPv2 multi-source rebalance

    {
      flow: [
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 2500000n,
          },
          dest: '@Base',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: 'Aave_Base',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 2500000n,
          },
          dest: '@Avalanche',
          detail: {
            cctpVersion: 2n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Base',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 2500000n,
          },
          dest: 'Aave_Avalanche',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Avalanche',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 5000000n,
          },
          dest: '@Optimism',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: 'Aave_Optimism',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 5000000n,
          },
          dest: '@agoric',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Optimism',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 5000000n,
          },
          dest: '@noble',
          src: '@agoric',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 2500000n,
          },
          dest: '@Arbitrum',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 2500000n,
          },
          dest: '@Ethereum',
          detail: {
            evmGas: 12n,
          },
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 14513220n,
          },
          src: '@noble',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 2500000n,
          },
          dest: 'Aave_Arbitrum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Arbitrum',
        },
        {
          amount: {
            brand: Object @Alleged: mock brand {},
            value: 2500000n,
          },
          dest: 'Aave_Ethereum',
          fee: {
            brand: Object @Alleged: fee brand (BLD) {},
            value: 5000000n,
          },
          src: '@Ethereum',
        },
      ],
      order: [
        [
          1,
          [
            0,
          ],
        ],
        [
          2,
          [
            1,
          ],
        ],
        [
          4,
          [
            3,
          ],
        ],
        [
          5,
          [
            4,
          ],
        ],
        [
          6,
          [
            5,
          ],
        ],
        [
          7,
          [
            5,
          ],
        ],
        [
          8,
          [
            6,
          ],
        ],
        [
          9,
          [
            7,
          ],
        ],
      ],
    }
